#!/bin/bash
# migrate-from-dip: Migrate dip configuration to hip
# Usage: ./bin/migrate-from-dip [--dry-run]

set -e

DRY_RUN=false
if [[ "$1" == "--dry-run" ]]; then
  DRY_RUN=true
  echo "üîç DRY RUN MODE - No changes will be made"
  echo ""
fi

function maybe_run() {
  if [[ "$DRY_RUN" == "true" ]]; then
    echo "[DRY RUN] Would execute: $*"
  else
    "$@"
  fi
}

echo "üîÑ Migrating dip configuration to hip..."
echo ""

# Track changes
CHANGES_MADE=false

# Rename config files in current directory
if [ -f dip.yml ]; then
  maybe_run mv dip.yml hip.yml
  echo "‚úÖ Renamed dip.yml ‚Üí hip.yml"
  CHANGES_MADE=true
fi

if [ -f dip.override.yml ]; then
  maybe_run mv dip.override.yml hip.override.yml
  echo "‚úÖ Renamed dip.override.yml ‚Üí hip.override.yml"
  CHANGES_MADE=true
fi

if [ -d .dip ]; then
  maybe_run mv .dip .hip
  echo "‚úÖ Renamed .dip/ ‚Üí .hip/"
  CHANGES_MADE=true
fi

# Migrate home directory
if [ -d ~/.dip ]; then
  if [ -d ~/.hip ]; then
    echo "‚ö†Ô∏è  Warning: ~/.hip already exists. Skipping home directory migration."
    echo "   Please manually merge ~/.dip into ~/.hip if needed."
  else
    maybe_run mv ~/.dip ~/.hip
    echo "‚úÖ Migrated ~/.dip ‚Üí ~/.hip"
    CHANGES_MADE=true
  fi
fi

echo ""

if [[ "$CHANGES_MADE" == "false" ]]; then
  echo "‚ÑπÔ∏è  No dip configuration files found to migrate."
  echo ""
  echo "If you're setting up hip for the first time:"
  echo "  - Create hip.yml instead of dip.yml"
  echo "  - Use .hip/ directory for modules instead of .dip/"
  echo "  - Use HIP_* environment variables instead of DIP_*"
  exit 0
fi

if [[ "$DRY_RUN" == "true" ]]; then
  echo ""
  echo "‚ú® Dry run complete! Run without --dry-run to apply changes."
  exit 0
fi

echo "‚ú® Migration complete!"
echo ""
echo "üìù Next steps:"
echo ""
echo "1. Update your shell configuration (.bashrc, .zshrc):"
echo "   OLD: eval \"\$(dip console)\""
echo "   NEW: eval \"\$(hip console)\""
echo ""
echo "2. Update environment variables in your scripts/CI:"
echo "   DIP_FILE ‚Üí HIP_FILE"
echo "   DIP_HOME ‚Üí HIP_HOME"
echo "   DIP_ENV ‚Üí HIP_ENV"
echo "   DIP_SHELL ‚Üí HIP_SHELL"
echo "   DIP_SKIP_VALIDATION ‚Üí HIP_SKIP_VALIDATION"
echo ""
echo "3. Update any scripts that reference 'dip' command:"
echo "   dip compose ‚Üí hip compose"
echo "   dip provision ‚Üí hip provision"
echo "   etc."
echo ""
echo "4. Test your configuration:"
echo "   hip --version"
echo "   hip list"
echo ""
