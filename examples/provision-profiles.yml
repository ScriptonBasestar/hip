# yaml-language-server: $schema=https://raw.githubusercontent.com/ScriptonBasestar/hip/refs/heads/master/schema.json
#
# Example: Provision Profiles Configuration
# Use Case: Demonstrates the power of provision profiles for different scenarios
# Features: Multiple named provision profiles for setup, reset, testing, deployment
#
# Usage:
#   hip provision              # Run default setup (alias for 'default' profile)
#   hip provision default      # Full project setup from scratch
#   hip provision reset        # Clean rebuild of everything
#   hip provision seed         # Re-seed database only
#   hip provision test         # Setup test environment
#   hip provision ci           # CI/CD pipeline setup
#   hip provision deploy       # Production deployment preparation
#
# Learn more: https://github.com/ScriptonBasestar/hip

version: '9.2.0'

environment:
  RAILS_ENV: development

compose:
  files:
    - docker-compose.yml

interaction:
  shell:
    description: Start a shell
    service: web
    command: /bin/bash

  rails:
    description: Run Rails commands
    service: web
    command: bundle exec rails

  bundle:
    description: Run bundle commands
    service: web
    command: bundle

  rake:
    description: Run Rake tasks
    service: web
    command: bundle exec rake

  rspec:
    description: Run RSpec tests
    service: web
    command: bundle exec rspec
    environment:
      RAILS_ENV: test

provision:
  # Note: Containers will auto-start if needed (since v9.1.3)
  # Default: Full setup for new developers
  default:
    - step: Installing dependencies
      run: hip bundle install

    - step: Setting up database
      run:
        - hip rails db:create
        - hip rails db:migrate
        - hip rails db:seed

    - step: Setup complete
      note: |
        âœ… Setup complete!
        Run 'hip rails server' to start the app

  # Reset: Nuclear option - rebuild everything from scratch
  reset:
    - step: Cleaning temporary files
      run:
        - rm -rf tmp/ log/*.log

    - step: Rebuilding containers
      run: hip compose build --no-cache

    - step: Reinstalling dependencies
      run: hip bundle install

    - step: Recreating database
      run: hip rails db:drop db:create db:migrate db:seed

    - step: Rebuilding assets
      run: hip rails assets:clobber assets:precompile

    - step: Reset complete
      note: Complete reset done!

  # Seed: Re-seed database without destroying data
  seed:
    - step: Seeding database
      run: hip rails db:seed

  # Update: Pull latest changes and update dependencies
  update:
    - step: Pulling latest changes
      run:
        - git pull origin main
        - hip compose pull

    - step: Updating dependencies
      run: hip bundle install

    - step: Running migrations
      run: hip rails db:migrate

    - step: Precompiling assets
      run: hip rails assets:precompile

    - step: Update complete
      note: Updated to latest version

  # Test: Setup test environment
  test:
    - step: Installing test dependencies
      run: RAILS_ENV=test hip bundle install

    - step: Setting up test database
      run: RAILS_ENV=test hip rails db:create db:migrate

    - step: Test environment ready
      note: Run 'hip rspec' to run tests

  # CI: Continuous Integration setup
  ci:
    - step: Installing dependencies
      run: hip bundle install --jobs 4 --retry 3

    - step: Loading database schema
      run: hip rails db:create db:schema:load

    - step: Precompiling assets
      run: hip rails assets:precompile

  # Deploy: Production deployment preparation
  deploy:
    - step: Building containers
      run: hip compose build

    - step: Running migrations
      run: hip rails db:migrate

    - step: Managing assets
      run:
        - hip rails assets:precompile
        - hip rails assets:clean

    - step: Ready for deployment
      note: Deployment preparation complete

  # Quick: Fast setup for minor updates
  quick:
    - step: Installing dependencies
      run: hip bundle install

    - step: Running migrations
      run: hip rails db:migrate

  # Clean: Clean up temporary files and caches
  clean:
    - step: Cleaning temporary files
      run:
        - rm -rf tmp/cache/*
        - rm -rf public/assets
        - rm -rf log/*.log
        - hip rails tmp:clear
